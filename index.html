<html lang="en">
    <head>
        <script src='https://d3js.org/d3.v5.min.js'></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
        <title>Beat The Market!</title>
    </head>
    

    <style>
        svg {
            border: 1px solid black;
        }

        body {
            border: 1px solid grey;
        }

        .nav-link {
            color: black;
        }

        #intro-paragraph {
            margin:auto;
            width: 50%;
            border: 1px solid grey;
        }
    </style>

    <body onload='init()'>
        <nav class="navbar navbar-expand-lg navbar-light bg-light justify-content-center">
            <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pills-saving-investing-tab" data-bs-toggle="pill" data-bs-target="#intro" type="button" role="tab" aria-controls="intro" aria-selected="true">Saving/Investing</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-cash-saver-tab" data-bs-toggle="pill" data-bs-target="#scene1" type="button" role="tab" aria-controls="scene1" aria-selected="false">Cash Saver</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-consistent-investor-tab" data-bs-toggle="pill" data-bs-target="#scene2" type="button" role="tab" aria-controls="scene2" aria-selected="false">Consistent Investor</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-beat-tab" data-bs-toggle="pill" data-bs-target="#scene3" type="button" role="tab" aria-controls="scene3" aria-selected="false">Beat The Market!</button>
                </li>
            </ul>
        </nav>

        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="intro" role="tabpanel" aria-labelledby="pills-saving-investing-tab">
                <div id="intro-paragraph">
                    INTRO
                </div>
            </div>

            <div class="tab-pane fade" id="scene1" role="tabpanel" aria-labelledby="pills-cash-saver-tab">
                <div id="tooltip1" style="display: none;"></div>
                <svg id="svg1" style="display: none;"></svg>
            </div>

            <div class="tab-pane fade" id="scene2" role="tabpanel" aria-labelledby="pills-consistent-investor-tab">
                <div id="tooltip2" style="display: none;"></div>
                <svg id="svg2" style="display: none;"></svg>
            </div>

            <div class="tab-pane fade" id="scene3" role="tabpanel" aria-labelledby="pills-beat-tab">
                <div id="tooltip3" style="display: none;"></div>
                <svg id="svg3" style="display: none;"></svg>
            </div>
        </div>
    </body>

    <script>
        // Global variables. Array is used for plotting. Dict is used for tooltip
        var data = null // Array of objects with keys date and price
        var dataDict = null // Object with key actual date and value price. Date in the format of fullYear-monthIndex-date
        var cashSaver =  null // Array of objects with keys date and cash total
        var cashSaverDict = null // Object with key actual date and value cash total. Date in the format of fullYear-monthIndex-date
        var consistentInvestor = null // Array of objects with keys date, market value and # of shares owned
        var consistentInvestorDict = null // Object with key actual date and value market value

        async function init() {
            // Clear page
            d3.selectAll("svg").html("")

            // Only get data if it's not available already
            if (!data) {await getData()}
            
            createInteractivePlot(cashSaver, cashSaverDict, "#svg1", "#tooltip1", "Cash Saver" , "Date", "Value - USD", [0.00,100000.00])
            createInteractivePlot(consistentInvestor, consistentInvestorDict, "#svg2", "#tooltip2", "Consistent Investor" , "Date", "Value - USD", [0.00, 300000.00])
            createInteractivePlot(data, dataDict, "#svg3", "#tooltip3", "S&P500" , "Date", "Value - USD", [0.00,4000.00])

            // To make page interactive
            d3.select(window).on('resize', init)
        }

        // Function to get data from .csv on the web and preprocess it to become data and dataDict
        async function getData() {
            // Get Data S&P500
            const originalData = await d3.csv('https://raw.githubusercontent.com/benhtan/beatTheMarket/main/S%26P500%20Prices.csv')
            // console.log(originalData)

            // Data cleanup. Format date to a date object, only use Open price as price
            data = [] // Array of objects with keys date and price
            dataDict = {} // Object with key actual date and value price. Date in the format of fullYear-monthIndex-date

            originalData.forEach( element => {
                // console.log(element)
                monthDayYear = element["Date"].split("/")

                if (parseInt("20" + monthDayYear[2]) > 2020) {
                    monthDayYear[2] = "19" + monthDayYear[2]
                }
                else {
                    monthDayYear[2] = "20" + monthDayYear[2]
                }

                for (let i = 0; i < monthDayYear.length; i++) {
                    monthDayYear[i] = parseInt( monthDayYear[i] )
                    // console.log(monthDayYear[i])
                }
                // console.log(monthDayYear)
                // console.log(`${element[" Open"]} ${parseFloat( element[" Open"] )}`)

                let date = new Date( monthDayYear[2], monthDayYear[0] - 1, monthDayYear[1] )
                let price = parseFloat( element[" Open"] )

                dataDict[`${monthDayYear[2]}-${monthDayYear[0] - 1}-${monthDayYear[1]}`] = price

                data.push( 
                    {
                        date: date, 
                        price: price
                    }
                )
            })

            console.log(data)
            console.log(dataDict)
            // console.log(dataDict[new Date(2000, 1, 1)])

            // Generating data for cashSaver and consistentInvestor
            cashSaver = []
            cashSaverDict = {}
            consistentInvestor = []
            consistentInvestorDict = {}
            // Finding startDate and endDate of data
            startEndDate = findStartEndDate(data[0].date, data[data.length-1].date)
            // console.log(startDate)
            // Creating cashSaverDict
            let cashEarned = 100.00 // USD earned on 1st and 15th of every month
            let currCash = cashEarned // Cash on the 1st
            let currDate = new Date(startEndDate.startDate.getFullYear(), startEndDate.startDate.getMonth(), 1) // The 1st date of starting year and month
            let currShares = currCash / findNextTradingDayPrice(formatDate(currDate), dataDict)  // Invenstor buy on the 1st, this is the share on the 1st. current number of shares owned = Cash/pricePerShare

            while (startEndDate.endDate >= currDate) {
                let newDate = new Date(currDate.getFullYear(), currDate.getMonth(), currDate.getDate())
                // Cash Saver Array
                cashSaver.push({
                    date: newDate,
                    cashTotal: currCash
                })

                // Cash Saver Dict
                cashSaverDict[formatDate(currDate)] = currCash

                // Consistent Investor Array
                let nextTradingDayPrice = findNextTradingDayPrice(formatDate(currDate), dataDict)
                consistentInvestor.push({
                    date: newDate,
                    marketValue: currShares * nextTradingDayPrice,  // # of shares * price per share at the date
                    numOfShares: currShares,
                    pricePerShare: nextTradingDayPrice
                })

                // Consistent Investor Dict
                consistentInvestorDict[formatDate(currDate)] = consistentInvestor[consistentInvestor.length - 1].marketValue

                currDate.setDate(currDate.getDate() + 1) // advance day by 1
                if ([1,15].includes(currDate.getDate())) {
                    currCash += cashEarned // add cash for cash saver
                    currShares += cashEarned / nextTradingDayPrice  // buy shares for consistent investor
                }
            }

            // console.log(cashSaver)
            // console.log(cashSaverDict)
            console.log(consistentInvestor)
            console.log(consistentInvestorDict)
        }

        function createInteractivePlot(data = [], dataDict = {}, svg = "#svg", tooltip = "#tooltip", plotTitle = "Title", xAxisLabel = "X", yAxisLabel = "Y", yRange = [0,500]) {
            const bodySize = document.querySelector("body").getBoundingClientRect()

            // Set svg canvas
            const svgWidth = bodySize.width * .75
            const svgHeight = svgWidth/2
            const plotMargin = bodySize.width * .1
            const plotWidth = svgWidth - plotMargin*2
            const plotHeight = svgHeight - plotMargin*2
            const plotFontSize = bodySize.width * .01

            const svg3 = d3.select(svg)
            .attr("width", svgWidth)
            .attr("height", svgHeight)
            .style("display", "block")
            .style("position", "absolute")  // needed for z index
            .style("z-index", "99") // so that svg is always above everything else
            .style("left", (bodySize.width - svgWidth)/2)
            

            // Scale
            // Finding startDate and endDate of data
            startEndDate = findStartEndDate(data[0].date, data[data.length-1].date)
            var xScale = d3.scaleTime().domain( [startEndDate.startDate, startEndDate.endDate] ).range([0, plotWidth])
            var yScale = d3.scaleLinear().domain( yRange ).range( [plotHeight, 0] )
            // console.log(yScale(2000))
            // console.log( xScale(data[2000].date) )
            // console.log(data[2000].date)

            // Get data object keys
            const objectKeys = Object.keys(data[0])
            // console.log(objectKeys)
            // Create main plot
            const line = d3.line()
                        .x(d => xScale( d[objectKeys[0]] ))
                        .y(d => yScale( d[objectKeys[1]] ))

            d3.select(svg)
            .append("g")
            .attr("transform", `translate(${plotMargin},${plotMargin})`)
            .append("path")
            .datum(data)
            .attr("fill", "none")
            .attr("stroke", "black")
            .attr("stroke-width", .5)
            .attr("d", line)

            // Plot title
            d3.select(svg)
            .append('g')
            .style("font-size", plotFontSize*1.3) // Responsive font size
            .attr('transform', `translate(${plotMargin + plotWidth/2},${plotMargin*0.6})`) // Specify where the label is
            .append('text')
            .attr('text-anchor', 'middle')
            .text(plotTitle)

            // Y tickmark
            d3.select(svg)
            .append("g")
            .attr("transform", `translate(${plotMargin},${plotMargin})`)
            .call( d3.axisLeft(yScale) )
            .style("font-size", plotFontSize) // Responsive font size

            // Y label
            d3.select(svg)
            .append('g')
            .style("font-size", plotFontSize*1.3) // Responsive font size
            .attr('transform', `translate(${plotMargin*0.5},${(plotHeight/2) + plotMargin})`) // Specify where the label is
            .append('text')
            .attr('text-anchor', 'middle')
            .attr('transform', 'rotate(-90)')
            .text(yAxisLabel)

            // X tickmark
            d3.select(svg)
            .append("g")
            .attr("transform", `translate(${plotMargin},${plotHeight + plotMargin})`)
            .call( d3.axisBottom(xScale).tickFormat(d3.timeFormat("%Y")) )
            .style("font-size", plotFontSize)   // Responsive font size

            // X label
            d3.select(svg)
            .append('g')
            .style("font-size", plotFontSize*1.3) // Responsive font size
            .attr('transform', `translate(${plotMargin + plotWidth/2},${plotHeight + plotMargin*1.4})`) // Specify where the label is
            .append('text')
            .attr('text-anchor', 'middle')
            .text(xAxisLabel)

            // Create tooltip vertical line
            d3.select(svg)
            .append("path")
            .attr("id", `toolTipLine${tooltip.substring(1)}`)

            // Create tooltip circle
            d3.select(svg)
            .append("circle")
            .attr("id", `toolTipCircle${tooltip.substring(1)}`)

            // Tool tip
            d3.selectAll(svg, tooltip, `#toolTipLine${tooltip.substring(1)}`, `#toolTipCircle${tooltip.substring(1)}`)
            .on("mousemove", () => {
                removeToolTip(tooltip)
                // Get size and location of svg
                const svgCoord = document.querySelector(svg).getBoundingClientRect()

                // Debugging
                // d3.select("#tooltip1").html(d3.event.pageX + " " + d3.event.pageY)
                // d3.select("#tooltip2").html(parseInt(d3.event.pageX - svgCoord.x) + " " + parseInt(d3.event.pageY - svgCoord.y))

                const cursorToToolTipOffset = 2 // in pixel. add offset so cursor is never on top of line, always on top of svg

                // Find relation between cursor location and plot data
                let cursorXLocationRelativeToPlot = d3.event.pageX - svgCoord.x - plotMargin + cursorToToolTipOffset // cursor location will be 0 and Y axis of plot
                let date = xScale.invert(parseInt(cursorXLocationRelativeToPlot))
                let nextTradingDayPrice = findNextTradingDayPrice(formatDate(date), dataDict) ? findNextTradingDayPrice(formatDate(date), dataDict) : 0 // if statement to remove toLocaleString error when date is outside of data range

                // Create date & price tooltip
                d3.select(tooltip).style("display", "block").style("position", "absolute")
                .html(`${nextTradingDayPrice.toLocaleString("en-US", {style:"currency", currency:"USD"})} USD - ${prettifyDate(date)}`)

                let toolTipCoord = document.querySelector(tooltip).getBoundingClientRect()    // Get tooltip size

                // Figuring out where tooltip div left should be. Tooltip div should not go outside of plot in x direction
                if (cursorXLocationRelativeToPlot - cursorToToolTipOffset - toolTipCoord.width/2 <= 0) {var toolTipLeft = plotMargin + svgCoord.x + cursorToToolTipOffset}
                else if (cursorXLocationRelativeToPlot - cursorToToolTipOffset + toolTipCoord.width/2 >= plotWidth) {var toolTipLeft = plotMargin + plotWidth + svgCoord.x + cursorToToolTipOffset - toolTipCoord.width}
                else {var toolTipLeft = d3.event.pageX - toolTipCoord.width/2}

                d3.select(tooltip)
                .style("top", svgCoord.y + plotMargin - toolTipCoord.height)
                .style("left", toolTipLeft) // Displaying tooltip div centered to cursor
                .style("font-size", plotFontSize)   // Responsive font size

                // debugging print
                // d3.select("#tooltip1").style("display", "block")
                // .html(`${d3.event.pageX} ${cursorXLocationRelativeToPlot} ${toolTipCoord.width}`)

                // Create tooltip vertical line
                const lineCircXCoord = d3.event.pageX - svgCoord.x + cursorToToolTipOffset // add offset so cursor is never on top of line, always on top of svg
                var toolTipLine = d3.line()([[lineCircXCoord, plotMargin], [lineCircXCoord, plotHeight + plotMargin]])
                if (cursorXLocationRelativeToPlot < 0 || cursorXLocationRelativeToPlot > plotWidth) {
                    removeToolTip(tooltip)
                }
                else {
                    // Show line
                    d3.select(`#toolTipLine${tooltip.substring(1)}`)
                    .attr("d", toolTipLine)
                    .attr("fill", "none")
                    .attr("stroke", "black")
                    .attr("stroke-width", .5)
                    
                    // Show circle
                    d3.select(`#toolTipCircle${tooltip.substring(1)}`)
                    .attr("cx", lineCircXCoord)
                    .attr("cy", yScale( nextTradingDayPrice ) + plotMargin)
                    .attr("r", 4)
                }
            })
            .on( "mouseout", () => {removeToolTip(tooltip)} )
        }

        function removeToolTip(tooltip) {
            // Remove line
            d3.select(`#toolTipLine${tooltip.substring(1)}`)
                    .attr("stroke-width", 0)

            // Remove circle
            d3.select(`#toolTipCircle${tooltip.substring(1)}`)
            .attr("r", 0)

            // Remove details
            d3.select(tooltip).style("display", "none")
        }

        function findNextTradingDayPrice(d, dataDict) {
            // if d is trading day, then return the price
            if (d in dataDict === true) {
                    return dataDict[d]
                }

            const yearMonthDay = d.split("-")
            var date = new Date(yearMonthDay[0], yearMonthDay[1], yearMonthDay[2])
            for (let i = 0; i < 7; i++) {
                date.setDate(date.getDate() + 1);
                // console.log(formatDate(date))
                if (formatDate(date) in dataDict) {
                    // console.log(`${date}`)
                    break
                }
            }
            return dataDict[formatDate(date)]
            
            // console.log(`${d}   ${date}    ${prevDayDate}`)
        }

        function formatDate(date) {
            return `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}` // return date object to string fullYear-monthIndex-Date
        }

        function prettifyDate(date) {
            let dateStringArray = date.toString().split(" ")
            return `${dateStringArray[1]} ${dateStringArray[2]}, ${dateStringArray[3]}`
        }

        function findStartEndDate(a = new Date(),b = new Date()) {
            if (a > b) { return {startDate: b, endDate: a} }
            return {startDate: a, endDate: b}
        }
    </script>
</html>
