<html>

<script src='https://d3js.org/d3.v5.min.js'></script>

<style>
svg {
    border: 1px solid black;
}
</style>

<body onload='init()'>
<div id="tooltip" opacity=0 height=50></div>
<div id="tooltip2" opacity=1 height=50></div>
<div id="tooltip3" opacity=1 height=50></div>

<script>
async function init() {
    // Get Data
    const originalData = await d3.csv('https://raw.githubusercontent.com/benhtan/beatTheMarket/main/S%26P500%20Prices.csv')
    // console.log(originalData)

    // Data cleanup. Format date to a date object, only use Open price as price
    var data = []
    originalData.forEach( element => {
        monthDayYear = element["Date"].split("/")

        if (parseInt("20" + monthDayYear[2]) > 2020) {
            monthDayYear[2] = "19" + monthDayYear[2]
        }
        else {
            monthDayYear[2] = "20" + monthDayYear[2]
        }

        for (let i = 0; i < monthDayYear.length; i++) {
            monthDayYear[i] = parseInt( monthDayYear[i] )
            // console.log(monthDayYear[i])
        }
        // console.log(monthDayYear)

        data.push( 
            {
                date: new Date( monthDayYear[2], monthDayYear[0] - 1, monthDayYear[1] ), 
                price: parseFloat( element[" Open"] )
            }
            )
    })

    // console.log(data)

    // Create svg canvas
    const svgWidth = 1500
    const svgHeight = 500
    const plotMargin = 50
    const plotWidth = svgWidth - plotMargin*2
    const plotHeight = svgHeight - plotMargin*2

    d3.select("body")
    .append("svg")
    .attr("width", svgWidth)
    .attr("height", svgHeight)
    .attr("id", "svg1")

    // Scale
    var xScale = d3.scaleTime().domain( [data[data.length-1].date, data[0].date] ).range([0, plotWidth])
    var yScale = d3.scaleLinear().domain( [0.00, 4000.00] ).range( [plotHeight, 0] )
    // console.log(yScale(2000))
    // console.log( xScale(data[2000].date) )
    // console.log(data[2000].date)

    // Plot
    // d3.select("#svg1")
    // .append("g")
    // .attr("transform", `translate(${plotMargin},${plotMargin})`) 
    // .selectAll("circle")
    // .data(data)
    // .enter()
    // .append("circle")
    // .attr( "cx", function (d) {return xScale( d.date )} )
    // .attr( "cy", function (d) {return yScale( d.price )} )
    // .attr("r",  0.5)

    const line = d3.line()
                .x(d => xScale( d.date ))
                .y(d => yScale( d.price ))

    d3.select("#svg1")
    .append("g")
    .attr("transform", `translate(${plotMargin},${plotMargin})`)
    .append("path")
    .datum(data)
    .attr("fill", "none")
    .attr("stroke", "black")
    .attr("stroke-width", .5)
    .attr("d", line)

    // Tool tip
    d3.select("#svg1")
    .on("mousemove", function(d) {
        let svgCoord = document.getElementById('svg1').getBoundingClientRect()
        d3.select("#tooltip").html(d3.event.pageX + " " + d3.event.pageY)
        d3.select("#tooltip2").html(parseInt(d3.event.pageX - svgCoord.x) + " " + parseInt(d3.event.pageY - svgCoord.y))
        d3.select("#tooltip3").html(xScale.invert(d3.event.pageX - plotMargin - svgCoord.x) + " " + yScale.invert(d3.event.pageY - plotMargin - svgCoord.y))
    })

    // Y Label
    d3.select("svg")
    .append("g")
    .attr("transform", `translate(${plotMargin},${plotMargin})`)
    .call( d3.axisLeft(yScale) )

    // X Label
    d3.select("svg")
    .append("g")
    .attr("transform", `translate(${plotMargin},${plotHeight + plotMargin})`)
    .call( d3.axisBottom(xScale).tickFormat(d3.timeFormat("%Y")) )

}
</script>
</body>
</html>
